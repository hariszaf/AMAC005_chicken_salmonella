// Choose container engine by setting its `enabled` feature as true
docker.enabled    = true
apptainer.enabled = false
singularity {
    enabled    = false
    autoMounts = true
    cacheDir   = "${HOME}/.singularity/mtg-images/"
    runOptions = getHPCBinds()
}

// Helper function for bindings 
def getHPCBinds() {

    // Automatically detects and binds common HPC directories (scratch spaces, tmp, cache) into Singularity containers, 
    // making the binding portable across different HPC systems without hardcoded paths. 

    def binds = ['--bind /tmp:/tmp', '--bind /var/tmp:/var/tmp']
    def home = System.getenv('HOME')

    // Bind home cache if it exists
    if (home && new File("${home}/.cache").exists()) {
        binds.add("--bind ${home}/.cache:${home}/.cache")
    }

    // Bind common HPC scratch spaces
    def scratchPaths = ['/scratch', '/lustre', '/work', '/gpfs/scratch']
    scratchPaths.each { path ->
        if (new File(path).exists()) {
            binds.add("--bind ${path}:${path}")
        }
    }

    // Bind TMPDIR if set (common on HPC)
    def tmpdir = System.getenv('TMPDIR')
    if (tmpdir && new File(tmpdir).exists()) {
        binds.add("--bind ${tmpdir}:${tmpdir}")
    }

    return binds.join(' ')
}

// Please do not edit
params {
    genomes = null
    faa_dir = null    
    recon_files = params.faa_dir ?: params.genomes  // Set recon_files based on hierarchy
}

